{% extends "html/base.html"%}
{% block title %}查询页面{% endblock %}
{% block script %}

{% endblock %}

{% block content%}
<div class="container" style="margin-top: 20px;">
    <div class="row" style="min-width: 960px;">
        <legend></legend>
        <form id="searchForm" class="form-inline" style="min-width: 960px;margin-bottom: 5px;">
            <div class="form-group">
                <label>代码：</label>
                <input type="text" size="12" class="form-control" name="code">
            </div>
            <div class="form-group">
                <label>名称：</label>
                <input type="text" size="12" class="form-control" name="name">
            </div>
             <div class="form-group">
                <label>最少匹配：</label>
                <input type="number" size="8" class="form-control"id="plate_count" name="plate_count" value="1" min="1">
            </div>
            <br>
            <div class="form-group">
                <label for="dtp_input2" class="control-label">减:</label>
                <div class="input-group date form_date" data-date="" data-date-format="yyyy-mm-dd">
                    <input class="form-control" size="8" type="text" name="jj_time" value="" readonly>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
					<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                </div>

            </div>
            <div class="form-group">
                <label for="dtp_input2" class="control-label">登记：</label>
                <div class="input-group date form_date" data-date="" data-date-format="yyyy-mm-dd" >
                    <input class="form-control" size="8" type="text" name="dj_time" value="" readonly>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
					<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                </div>

            </div>
            <br>
            <div class="form-group control-label">
                <label>板块类型：</label>
            </div>
            <div class="form-group">
                <select class="selectpicker" size="8" name="type" multiple>
                    <option value="sh">沪市</option>
                    <option value="sz">深市</option>
                    <option value="sz">创业</option>
                </select>
            </div>
            <div class="form-group control-label">  <label>区域：</label></div>
            <div class="form-group">

                <select id="area_select" size="8" name="area" class="selectpicker" multiple
                        data-live-search="true"></select>
            </div>
             <div class="form-group control-label">  <label>板块：</label></div>
            <div class="form-group">

                <select id="concept_select" size="16" name="concept" class="selectpicker" multiple
                        data-live-search="true" ></select>
            </div>
            <div class="form-group">
                <a href="javascript:void(0);"  data-loading-text="搜索中..."  id="searchBtn" class="btn btn-primary">搜索</a>
            </div>
        </form>
        <legend></legend>
        <table class="table  table-bordered table-hover  table-condensed" id="table_search">
            <thead>
            <tr>
                <th>
                </th>
                <th>
                    序号
                </th>
                <th>
                    代码
                </th>
                <th>
                    名称
                </th>
                <th>
                    当前价格
                </th>
                <th>
                    换手
                </th>
                <th>
                    涨幅
                </th>
                 <th>
                    开/昨收
                </th>
                 <th>
                    高/低
                </th>
                <th>
                    事件日期
                </th>

                <th>
                    板块
                </th>
                <th>
                    均值
                </th>
                <th>
                    基金
                </th>
                <th>
                    操作
                </th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
</div>
<!-- Modal -->
<div class="modal fade bs-example-modal-lg" id="fund_list_modal" tabindex="-1" role="dialog" aria-labelledby="fund_list_modal_label">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="fund_list_modal_label">基金列表</h4>
      </div>
      <div class="modal-body">
            <table class="table  table-bordered table-hover  table-condensed" id="fund_list_table">
            <thead>
            <tr>
                <th>
                </th>
                <th>
                    序号
                </th>
                <th>
                    代码
                </th>
                <th>
                    名称
                </th>
                <th>
                    当前价格
                </th>
                <th>
                    涨幅
                </th>
                <th>
                    卖出状态
                </th>
                 <th>
                    买入状态
                </th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>

      </div>
    </div>
  </div>
</div>
{% endblock%}

{% block footScript %}

<script id="STOCK_LIST_TPL" type="text/html">
    <%for(var i = 0; i < list.length; i++) { %>
    <tr class="<%:=list[i].cur.price>list[i].cur.close_price?'danger':''%>">
        <th scope="row"><input type="checkbox" value="<%:=list[i].code%>"></th>
        <th><%:=i+1 %></th>
        <td><%:=list[i].code%></td>
        <td><%:=list[i].name%></td>
        <td><%:=list[i].cur.price%></td>
        <td><%:=list[i].cur.turnover_rate%></td>
        <td><%:=list[i].cur.growth%></td>
        <td>
            开：<%:=list[i].cur.open_price%><br/>
            昨：<%:=list[i].cur.close_price%>
        </td>
        <td>
            高：<%:=list[i].cur.high_price%><br/>
            低：<%:=list[i].cur.low_price%>
        </td>
        <td>
            解禁：<%:=list[i].jj_time%><br/>
            登记：<%:=list[i].dj_time%>
        </td>
        <td style="max-width: 200px;"><%:=list[i].plate_name%></td>
        <td >
            <%if(list[i].avg){for(var a=0;a< list[i].avg.length;a++){ %><%:=JSON.stringify(list[i].avg[a]).replace(",","：").replace(/,/g,"--")%><br/><% }}%></td>

        <td onclick="getFundList('<%:=list[i].code%>')">
            基金：<%:=list[i].fund_count%><br/>
            数量：<%:=list[i].fund_quantity%><br/>
            市值：<%:=list[i].fund_mc%><br/>
        </td>
        <td>
            <div class="btn-toolbar" role="toolbar" aria-label="...">
                <div class="btn-group glyphicon glyphicon-edit" role="group"></div>
                <div class="btn-group glyphicon glyphicon-remove-circle" role="group"></div>
            </div>
        </td>
    </tr>
    <%  }%>
</script>

<script id="FUND_LIST_TPL" type="text/html">
    <%for(var i = 0; i < list.length; i++) { %>
    <tr class="<%:=list[i].growth>0?'danger':''%>">
        <th scope="row"><input type="checkbox" value="<%:=list[i].fund_code%>"></th>
        <th><%:=i+1 %></th>
        <td><%:=list[i].fund_code%></td>
        <td><%:=list[i].fund_name%></td>
        <td><%:=list[i].cur_price%></td>
        <td><%:=list[i].growth%></td>
        <td><%:=list[i].sell%></td>
        <td><%:=list[i].buy%></td>
    </tr>
    <%  }%>
</script>
<script type="text/javascript">
    window.template();
    $('.form_date').datetimepicker({
        weekStart: 1,
        todayBtn:  1,
		autoclose: 1,
		todayHighlight: 1,
		startView: 2,
		minView: 2,
		forceParse: 0
    });
    function init() {
        request("/shares/plate", null, function (data) {
            var area = "";
            var concept="";
            for(var i=0;i<data.length;i++){
                var d = data[i];
                if(d.type=='AREA'){
                    area+="<option value='"+d.code+"'>"+d.name+"</option>>"
                }
                else{
                    concept+="<option value='"+d.code+"'>"+d.name+"</option>>"
                }
            }
            $('#area_select').empty().append(area).selectpicker('refresh');
            $('#concept_select').empty().append(concept).selectpicker('refresh');
            $('#concept_select').on('changed.bs.select', function (e) {
                var arr = $('#concept_select').selectpicker('val');
                if(arr){
                    var len = arr.length;
                    $("#plate_count").val(len>0?len:1);
                }
            });
        }, null);
//        $('#area_select').selectpicker('refresh');
//        $('#concept_select').selectpicker('refresh');
    }

    init();

    $('#searchBtn').click(function(){
        var $btn = $(this).button('loading')

        var params = $("#searchForm").getJsonData();
        request("/shares/stockSearch",params , function (data) {
            $("#table_search tbody").empty();
            if(data.length==0){
                 $("#table_search tbody").append("<tr><td>无数据</td></tr>");
            }

            var tpl = document.getElementById('STOCK_LIST_TPL').innerHTML;
            $("#table_search tbody").append(template(tpl, {"list":data}));

            $btn.button('reset')
        }, null)
    });

    function getFundList(stockCode) {
        request("/fund/fundListByStock",{"stock_code":stockCode} , function (data) {
            $("#fund_list_table tbody").empty();
            $("#fund_list_modal").modal('show');
            if(data.length==0){
                 $("#table_search tbody").append("<tr><td>无数据</td></tr>");
            }
            var tpl = document.getElementById('FUND_LIST_TPL').innerHTML;
            $("#fund_list_table tbody").append(template(tpl, {"list":data}));
        }, null)
    }

</script>


{% endblock%}